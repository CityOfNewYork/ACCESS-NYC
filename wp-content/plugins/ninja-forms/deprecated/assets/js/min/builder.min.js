var nfField=Backbone.Model.extend({toggleMetabox:function(){var e=this.id,n=this.get("metabox_state");if(1==n)var t=0;else var t=1;1==t?this.updateHTML():(this.updateData(),jQuery("#ninja_forms_field_"+e+"_inside").find("div.rte").each(function(){if("undefined"!=typeof tinymce)try{var e=jQuery(this).find("textarea.wp-editor-area").prop("id");tinymce.remove("#"+e)}catch(n){}}),jQuery("#ninja_forms_field_"+e+"_inside").slideUp("fast",function(){jQuery("#ninja_forms_field_"+e+"_inside").empty(),jQuery("#ninja_forms_field_"+e+"_inside").addClass("no-padding")})),this.set("metabox_state",t)},updateHTML:function(){var e=this.id;jQuery("#ninja_forms_metabox_field_"+e).find(".spinner").show(),jQuery("#ninja_forms_metabox_field_"+e).find(".spinner").css("visibility","visible"),this.updateData();var n=JSON.stringify(this.toJSON()),t=this;jQuery.post(ajaxurl,{field_id:e,data:n,action:"nf_output_field_settings_html",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(n){if(jQuery("#ninja_forms_metabox_field_"+e).find(".spinner").hide(),jQuery("#ninja_forms_field_"+e+"_inside").removeClass("no-padding"),jQuery("#ninja_forms_field_"+e+"_inside").append(n),"undefined"!=typeof nf_ajax_rte_editors&&"undefined"!=typeof tinyMCE)for(var i=nf_ajax_rte_editors.length-1;i>=0;i--)try{var a=nf_ajax_rte_editors[i];tinyMCE.init(tinyMCEPreInit.mceInit[a]);try{quicktags(tinyMCEPreInit.qtInit[a])}catch(s){console.log("error")}}catch(s){}t.removeEmptySettings(),jQuery("#ninja_forms_field_"+e+"_inside").slideDown("fast"),nfFields.listOptionsSortable(),jQuery(".nf-field-settings .title").disableSelection()})},updateData:function(){var e=this.id;if("undefined"!=typeof tinyMCE)try{tinyMCE.triggerSave()}catch(n){}var t=jQuery("[name^=ninja_forms_field_"+e+"]"),i=jQuery(t).serializeFullArray();if("undefined"!=typeof i["ninja_forms_field_"+e]){var a=i["ninja_forms_field_"+e];for(var s in a)a.hasOwnProperty(s)&&nfFields.get(e).set(s,a[s])}nfForm.set("saved",!1)},remove:function(){var e=this.id,n=confirm(nf_admin.remove_field);n&&jQuery.post(ajaxurl,{field_id:e,action:"ninja_forms_remove_field",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(){jQuery("#ninja_forms_field_"+e).remove(),jQuery(document).trigger("removeField",[e])})},removeEmptySettings:function(){var e=this.id;jQuery("#ninja_forms_field_"+e+"_inside").find(".nf-field-settings .inside").each(function(){var e=jQuery.trim(jQuery(this).html());""==e&&jQuery(this).parent().remove()})}}),nfFields=Backbone.Collection.extend({model:nfField,setup:function(){"undefined"!=typeof nf_admin.fields&&_.each(nf_admin.fields,function(e){nfFields.add({id:e.id,metabox_state:e.metabox_state})})},updateData:function(){_.each(this.models,function(e){1==e.get("metabox_state")&&e.updateData()})},newField:function(e){var n=jQuery(e).data("limit"),t=jQuery(e).data("type"),i=ninja_forms_settings.form_id;if(""!=n)var a=jQuery("."+t+"-li").length;else var a="";if("undefined"==typeof jQuery(e).data("field"))var s="",r="ninja_forms_new_field";else if("fav"==jQuery(e).data("type"))var s=jQuery(e).data("field"),r="ninja_forms_insert_fav";else var s=jQuery(e).data("field"),r="ninja_forms_insert_def";""!=n&&n>a||""==n||""==a||0==a?jQuery.post(ajaxurl,{type:t,field_id:s,form_id:i,action:r,nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},this.newFieldResponse):jQuery(e).addClass("disabled"),nfForm.set("saved",!1)},newFieldResponse:function(e){jQuery(document).trigger("addField",[e])},addFieldDefault:function(e){if(jQuery("#ninja_forms_field_list").append(e.new_html).show("slow"),"List"==e.new_type&&this.listOptionsSortable(),"undefined"!=typeof nf_ajax_rte_editors&&"undefined"!=typeof tinyMCE)for(var n=nf_ajax_rte_editors.length-1;n>=0;n--)try{var t=nf_ajax_rte_editors[n];tinyMCE.init(tinyMCEPreInit.mceInit[t]);try{quicktags(tinyMCEPreInit.qtInit[t])}catch(i){}}catch(i){}this.add({id:e.new_id,metabox_state:1}),nfFields.get(e.new_id).removeEmptySettings()},listOptionsSortable:function(){jQuery(".ninja-forms-field-list-options").sortable({helper:"clone",handle:".ninja-forms-drag",items:"div",placeholder:"ui-state-highlight",update:function(){var e=jQuery(this).sortable("toArray"),n=0;_.each(e,function(e){var t=jQuery("#"+e).data("field"),i="ninja_forms_field_"+t+"[list][options]["+n+"][label]",a="ninja_forms_field_"+t+"[list][options]["+n+"][value]",s="ninja_forms_field_"+t+"[list][options]["+n+"][calc]",r="ninja_forms_field_"+t+"[list][options]["+n+"][selected]";jQuery("#"+e).find(".ninja-forms-field-list-option-label").attr("name",i),jQuery("#"+e).find(".ninja-forms-field-list-option-value").attr("name",a),jQuery("#"+e).find(".ninja-forms-field-list-option-calc").attr("name",s),jQuery("#"+e).find(".ninja-forms-field-list-option-selected").attr("name",r),n++})}})}}),nfForm=Backbone.Model.extend({defaults:{id:ninja_forms_settings.form_id,status:nf_admin.form_status,title:nf_admin.form_title,saved:!0},setup:function(){this.changeMenu()},changeMenu:function(){if("new"==this.get("status"))jQuery(".wp-submenu li").removeClass("current"),jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().addClass("current");else{var e='<li class="current"><a href="#">'+nf_admin.edit_form_text+"</a></li>";0==jQuery('li a:contains("'+nf_admin.edit_form_text+'")').length&&(jQuery(".wp-submenu li").removeClass("current"),jQuery('a[href="admin.php?page=ninja-forms&tab=builder&form_id=new"]').parent().after(e))}},save:function(){if(jQuery(".nf-save-admin-fields").hide(),jQuery(".nf-save-spinner").show(),jQuery(".nf-save-spinner").css("visibility","visible"),"new"==this.get("status"))return jQuery("._submit-li").length>0?(jQuery("#nf-insert-submit-div").hide(),this.set("show_insert_submit",!1)):(jQuery("#nf-insert-submit-div").show(),this.set("show_insert_submit",!0)),jQuery("#nf-save-title").nfAdminModal("open"),jQuery("#modal-contents-wrapper").find("#nf-form-title").focus(),!1;nfFields.updateData();for(var e=JSON.stringify(nfFields.toJSON()),n={},t=jQuery("#ninja_forms_field_list").sortable("toArray"),i=0;i<t.length;i++)n[i]=t[i];n=JSON.stringify(n);var a=ninja_forms_settings.form_id;jQuery(document).data("field_order",n),jQuery(document).data("field_data",e),jQuery(document).triggerHandler("nfAdminSaveFields");{var n=jQuery(document).data("field_order");jQuery(document).data("field_data")}jQuery.post(ajaxurl,{form_title:this.get("title"),form_id:a,field_data:e,field_order:n,action:"nf_admin_save_builder",nf_ajax_nonce:ninja_forms_settings.nf_ajax_nonce},function(){jQuery(".nf-save-spinner").hide(),jQuery(".nf-save-admin-fields").show();var e='<div id="message" class="updated below-h2" style="display:none;margin-top: 20px;"><p>'+nf_admin.saved_text+"</p></div>";jQuery(".nav-tab-wrapper:last").after(e),jQuery("#message").fadeIn(),""==jQuery("#nf-display-form-title").html()&&jQuery("#nf-display-form-title").html(nfForm.get("title")),nfForm.set("saved",!0),nfForm.set("status",""),nfForm.changeMenu()})},saveTitle:function(){var e=jQuery("#modal-contents-wrapper").find("#nf-form-title").val(),n=this.get("show_insert_submit"),t=jQuery("#modal-contents-wrapper").find("#nf-insert-submit").prop("checked");if(this.set("title",e),this.set("status",""),n&&t){var i=this;jQuery(document).on("addField.insertSubmit",function(e,n){jQuery("#ninja_forms_field_"+n.new_id+"_toggle").click(),jQuery("#nf-save-title").nfAdminModal("close"),i.save(),jQuery(document).off("addField.insertSubmit")}),jQuery("#_submit").click()}else jQuery("#nf-save-title").nfAdminModal("close"),this.save()}}),nfFields=new nfFields,nfForm=new nfForm;!function(e){e(document).ready(function(e){nfFields.setup(),nfForm.setup(),e(document).on("click",".nf-edit-field",function(n){n.preventDefault();var t=jQuery(n.target).data("field");nfFields.get(t).toggleMetabox();var i=nfFields.get(t).get("metabox_state");1==i?e(this).addClass("open"):e(this).removeClass("open")}),e(document).on("click",function(){e("#message").fadeOut("slow")}),e(document).on("click",".nf-save-admin-fields",function(e){e.preventDefault(),nfForm.save()}),e(document).on("click","#nf-save-title-submit",function(e){e.preventDefault(),nfForm.saveTitle()}),e(document).on("click",".ninja-forms-new-field",function(e){e.preventDefault(),nfFields.newField(e.target)}),e(document).on("click",".nf-remove-field",function(e){e.preventDefault();var n=jQuery(e.target).data("field");nfFields.get(n).remove()}),e(document).on("addField.default",function(e,n){nfFields.addFieldDefault(n)}),e(document).on("click",".ninja-forms-insert-fav-field",function(e){e.preventDefault(),nfFields.newField(e.target)}),e(document).on("click",".ninja-forms-insert-def-field",function(e){e.preventDefault(),nfFields.newField(e.target)}),e("#nf-save-title").nfAdminModal({title:"Save Your Form",buttons:"#nf-save-title-buttons"}),e(document).on("nfAdminModalClose.hideSpinners",function(){jQuery(".nf-save-spinner").hide(),jQuery(".nf-save-admin-fields").show()}),e(document).on("keyup","#nf-form-title",function(n){this.value;this.value.length>0?(e("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",!1),e("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-secondary"),e("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-primary")):(e("#modal-contents-wrapper").find("#nf-save-title-submit").prop("disabled",!0),e("#modal-contents-wrapper").find("#nf-save-title-submit").removeClass("button-primary"),e("#modal-contents-wrapper").find("#nf-save-title-submit").addClass("button-secondary")),13==n.keyCode&&this.value.length>0&&nfForm.saveTitle()}),e(".ninja-forms-field-list").sortable({handle:".menu-item-handle",items:"li:not(.not-sortable)",connectWith:".ninja-forms-field-list",start:function(n,t){var i=e(t.item).find(".wp-editor-wrap").length;i>0&&e(t.item).find(".wp-editor-wrap").each(function(){try{var e=this.id.replace("wp- ","");e=e.replace("-wrap",""),tinyMCE.execCommand("mceRemoveControl",!1,e)}catch(n){}})},stop:function(n,t){var i=e(t.item).find(".wp-editor-wrap").length;i>0&&e(t.item).find(".wp-editor-wrap").each(function(){try{var e=this.id.replace("wp-","");e=e.replace("-wrap",""),tinyMCE.execCommand("mceAddControl",!0,e)}catch(n){}}),e(this).sortable("refresh"),nfForm.set("saved",!1)}}),e(document).on("dblclick",".nf-field-settings .title",function(){e(this).find(".nf-field-sub-section-toggle").click()}),e(document).on("click",".nf-field-sub-section-toggle",function(n){n.preventDefault(),e(this).hasClass("dashicons-arrow-down")?e(this).removeClass("dashicons-arrow-down").addClass("dashicons-arrow-up"):e(this).removeClass("dashicons-arrow-up").addClass("dashicons-arrow-down"),e(this).parent().next(".inside").slideToggle()}),e(window).bind("beforeunload",function(){return"new"==nfForm.get("status")?(e("#nf-save-title").nfAdminModal("open"),"Please save your form before leaving this page."):0==nfForm.get("saved")?"You have unsaved changes. Please save before leaving this page.":void 0}),e(document).on("dblclick",".menu-item-handle",function(){e(this).find(".nf-edit-field").click()})})}(jQuery);